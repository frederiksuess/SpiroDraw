<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SpiroDraw</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap');

  :root {
    --bg: #0a0a0f;
    --panel: #111118;
    --border: #1e1e2e;
    --accent: #ff2d55;
    --accent2: #0ff;
    --text: #e0e0f0;
    --muted: #444466;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    user-select: none;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 14px;
    background: var(--panel);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  header h1 {
    font-family: 'Orbitron', sans-serif;
    font-size: 16px;
    letter-spacing: 3px;
    color: var(--accent);
    text-shadow: 0 0 12px var(--accent);
  }

  header .hbtn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    padding: 5px 10px;
    cursor: pointer;
    border-radius: 3px;
    letter-spacing: 1px;
    transition: all .2s;
  }
  header .hbtn:active { background: var(--accent); border-color: var(--accent); }

  #canvas-wrap {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: #050508;
    cursor: crosshair;
  }
  #canvas-wrap.stamp-mode { cursor: cell; }

  canvas {
    position: absolute;
    top: 0; left: 0;
    touch-action: none;
  }

  .toolbar {
    background: var(--panel);
    border-top: 1px solid var(--border);
    flex-shrink: 0;
  }

  .toolbar-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
  }

  .tab-btn {
    flex: 1;
    background: none;
    border: none;
    color: var(--muted);
    font-family: 'Share Tech Mono', monospace;
    font-size: 9px;
    letter-spacing: 0.5px;
    padding: 7px 2px;
    cursor: pointer;
    transition: all .2s;
    border-bottom: 2px solid transparent;
  }
  .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

  .tab-panel {
    display: none;
    padding: 10px 12px;
    min-height: 58px;
  }
  .tab-panel.active { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }

  .color-swatch {
    width: 28px; height: 28px;
    border-radius: 50%;
    border: 2px solid transparent;
    cursor: pointer;
    transition: transform .15s, border-color .15s;
    flex-shrink: 0;
  }
  .color-swatch.selected { border-color: white; transform: scale(1.25); }

  input[type="color"] {
    width: 28px; height: 28px;
    border-radius: 50%;
    border: 2px solid var(--border);
    cursor: pointer;
    padding: 0;
    background: none;
    flex-shrink: 0;
  }

  .ctrl-group {
    display: flex;
    flex-direction: column;
    gap: 3px;
    flex: 1;
    min-width: 90px;
  }
  .ctrl-group label { font-size: 9px; color: var(--muted); letter-spacing: 1px; }

  input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    outline: none;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px; height: 14px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    box-shadow: 0 0 6px var(--accent);
  }

  .sym-btn {
    background: var(--border);
    border: 1px solid var(--muted);
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    padding: 6px 10px;
    cursor: pointer;
    border-radius: 3px;
    letter-spacing: 1px;
    transition: all .2s;
  }
  .sym-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
    box-shadow: 0 0 8px var(--accent);
  }

  .mode-btn {
    background: var(--border);
    border: 1px solid var(--muted);
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 3px;
    transition: all .2s;
  }
  .mode-btn.active {
    background: #0ff2;
    border-color: var(--accent2);
    color: var(--accent2);
    box-shadow: 0 0 6px var(--accent2);
  }

  .spiro-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 10px;
    color: var(--text);
    letter-spacing: 1px;
  }
  .toggle-switch { position: relative; width: 36px; height: 18px; }
  .toggle-switch input { display: none; }
  .toggle-switch .slider-track {
    position: absolute;
    inset: 0;
    background: var(--border);
    border-radius: 9px;
    transition: background .2s;
    cursor: pointer;
  }
  .toggle-switch .slider-track::after {
    content: '';
    position: absolute;
    width: 12px; height: 12px;
    border-radius: 50%;
    background: var(--muted);
    top: 3px; left: 3px;
    transition: all .2s;
  }
  .toggle-switch input:checked + .slider-track { background: var(--accent); }
  .toggle-switch input:checked + .slider-track::after {
    left: 21px;
    background: white;
    box-shadow: 0 0 4px var(--accent);
  }

  /* â”€â”€ STAMP TAB â”€â”€ */
  #tab-stempel {
    flex-wrap: nowrap;
    overflow-x: auto;
    padding: 8px 12px;
    scrollbar-width: none;
    gap: 6px;
    align-items: center;
  }
  #tab-stempel::-webkit-scrollbar { display: none; }

  .stamp-pick {
    font-size: 22px;
    width: 38px; height: 38px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 6px;
    border: 2px solid var(--border);
    cursor: pointer;
    flex-shrink: 0;
    transition: border-color .15s, transform .12s;
    background: var(--bg);
  }
  .stamp-pick.selected {
    border-color: var(--accent);
    transform: scale(1.18);
    box-shadow: 0 0 8px var(--accent);
  }

  .stamp-size-wrap {
    display: flex;
    flex-direction: column;
    gap: 3px;
    min-width: 80px;
    flex-shrink: 0;
  }
  .stamp-size-wrap label { font-size: 9px; color: var(--muted); letter-spacing: 1px; }

  #save-flash {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0);
    background: rgba(255,45,85,.92);
    color: white;
    font-family: 'Orbitron', sans-serif;
    font-size: 18px;
    letter-spacing: 4px;
    padding: 16px 32px;
    border-radius: 4px;
    pointer-events: none;
    transition: transform .2s, opacity .3s;
    opacity: 0;
    z-index: 100;
  }
  #save-flash.show { transform: translate(-50%, -50%) scale(1); opacity: 1; }
</style>
</head>
<body>

<header>
  <h1>SPIRODRAW</h1>
  <div style="display:flex;gap:6px">
    <button class="hbtn" id="undoBtn">UNDO</button>
    <button class="hbtn" id="clearBtn">CLR</button>
    <button class="hbtn" id="saveBtn" style="border-color:var(--accent);color:var(--accent)">SAVE</button>
  </div>
</header>

<div id="canvas-wrap">
  <canvas id="bgCanvas"></canvas>
  <canvas id="mainCanvas"></canvas>
</div>

<div class="toolbar">
  <div class="toolbar-tabs">
    <button class="tab-btn active" data-tab="farbe">FARBE</button>
    <button class="tab-btn" data-tab="strich">STRICH</button>
    <button class="tab-btn" data-tab="sym">SYMMETRIE</button>
    <button class="tab-btn" data-tab="spiro">SPIROGRAPH</button>
    <button class="tab-btn" data-tab="stempel">STEMPEL</button>
  </div>

  <!-- FARBE -->
  <div class="tab-panel active" id="tab-farbe">
    <div class="color-swatch selected" style="background:#ff2d55" data-color="#ff2d55"></div>
    <div class="color-swatch" style="background:#ff9f0a" data-color="#ff9f0a"></div>
    <div class="color-swatch" style="background:#ffd60a" data-color="#ffd60a"></div>
    <div class="color-swatch" style="background:#30d158" data-color="#30d158"></div>
    <div class="color-swatch" style="background:#0ff" data-color="#0ff"></div>
    <div class="color-swatch" style="background:#0a84ff" data-color="#0a84ff"></div>
    <div class="color-swatch" style="background:#bf5af2" data-color="#bf5af2"></div>
    <div class="color-swatch" style="background:#ff375f" data-color="#ff375f"></div>
    <div class="color-swatch" style="background:#ffffff" data-color="#ffffff"></div>
    <input type="color" id="customColor" value="#ff2d55" title="Eigene Farbe">
    <div class="ctrl-group" style="min-width:80px">
      <label>TRANSPARENZ</label>
      <input type="range" id="alphaSlider" min="5" max="100" value="90">
    </div>
  </div>

  <!-- STRICH -->
  <div class="tab-panel" id="tab-strich">
    <div class="ctrl-group">
      <label>BREITE</label>
      <input type="range" id="sizeSlider" min="1" max="40" value="3">
    </div>
    <div class="ctrl-group">
      <label>GLÃœHEN</label>
      <input type="range" id="glowSlider" min="0" max="30" value="8">
    </div>
    <button class="mode-btn active" data-mode="round">â—</button>
    <button class="mode-btn" data-mode="square">â– </button>
    <div class="spiro-toggle" style="margin-left:auto">
      <span>RAINBOW</span>
      <label class="toggle-switch">
        <input type="checkbox" id="rainbowToggle">
        <span class="slider-track"></span>
      </label>
    </div>
  </div>

  <!-- SYMMETRIE -->
  <div class="tab-panel" id="tab-sym">
    <button class="sym-btn" data-sym="1">1Ã—</button>
    <button class="sym-btn active" data-sym="4">4Ã—</button>
    <button class="sym-btn" data-sym="6">6Ã—</button>
    <button class="sym-btn" data-sym="8">8Ã—</button>
    <button class="sym-btn" data-sym="12">12Ã—</button>
    <div class="spiro-toggle">
      <span>SPIEGEL</span>
      <label class="toggle-switch">
        <input type="checkbox" id="mirrorToggle" checked>
        <span class="slider-track"></span>
      </label>
    </div>
  </div>

  <!-- SPIROGRAPH -->
  <div class="tab-panel" id="tab-spiro">
    <div class="spiro-toggle">
      <span>SPIROGRAPH</span>
      <label class="toggle-switch">
        <input type="checkbox" id="spiroToggle">
        <span class="slider-track"></span>
      </label>
    </div>
    <div class="ctrl-group">
      <label>INNEN-R</label>
      <input type="range" id="spiroR" min="10" max="120" value="60">
    </div>
    <div class="ctrl-group">
      <label>OFFSET</label>
      <input type="range" id="spiroD" min="1" max="120" value="40">
    </div>
    <div class="ctrl-group">
      <label>GESCHWINDIGKEIT</label>
      <input type="range" id="spiroSpeed" min="1" max="12" value="4">
    </div>
  </div>

  <!-- STEMPEL -->
  <div class="tab-panel" id="tab-stempel">
    <div id="stampRow" style="display:flex;gap:6px;flex-shrink:0"></div>
    <div style="width:1px;height:32px;background:var(--border);flex-shrink:0"></div>
    <div class="stamp-size-wrap">
      <label>GRÃ–SSE</label>
      <input type="range" id="stampSize" min="16" max="120" value="40">
    </div>
  </div>
</div>

<div id="save-flash">GESPEICHERT</div>

<script>
// â”€â”€ Canvases â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const wrap       = document.getElementById('canvas-wrap');
const bgCanvas   = document.getElementById('bgCanvas');
const mainCanvas = document.getElementById('mainCanvas');
const bgCtx      = bgCanvas.getContext('2d');
const ctx        = mainCanvas.getContext('2d');
const DPR        = window.devicePixelRatio || 1;

// â”€â”€ State (MUST be before resize()) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let color      = '#ff2d55';
let alpha      = 0.9;
let lineWidth  = 3;
let glowAmount = 8;
let symmetry   = 4;
let mirror     = true;
let rainbow    = false;
let lineCap    = 'round';
let spiroMode  = false;
let spiroR     = 60, spiroD = 40, spiroSpeed = 4;
let hue        = 0;
let history    = [];
let isDrawing  = false;
let lastX, lastY;
let spiroAngle = 0;
let spiroActive = false;
let spiroRAF    = null;
let spiroLastX, spiroLastY;
let W, H;

// stamp state
let stampMode   = false;
let stampEmoji  = 'â­';
let stampSizePx = 40;

// â”€â”€ Stamp picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STAMPS = [
  'â­','ğŸŒŸ','ğŸ’«','âœ¨','â¤ï¸','ğŸ”¥','ğŸ’¥','ğŸŒ€',
  'ğŸŒ¸','ğŸŒº','ğŸ€','ğŸ¦‹','ğŸŒ™','â˜€ï¸','â„ï¸','ğŸ’',
  'ğŸ¯','ğŸ¨','ğŸ­','ğŸ”®','ğŸŒˆ','ğŸ','ğŸ¦„','ğŸµ',
  'ğŸµï¸','ğŸŒ»','ğŸ†','ğŸ’ '
];

(function buildStampPicker() {
  const row = document.getElementById('stampRow');
  STAMPS.forEach((em, i) => {
    const btn = document.createElement('div');
    btn.className = 'stamp-pick' + (i === 0 ? ' selected' : '');
    btn.textContent = em;
    btn.addEventListener('click', () => {
      document.querySelectorAll('.stamp-pick').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      stampEmoji = em;
    });
    row.appendChild(btn);
  });
})();

// â”€â”€ Resize: scale canvas for device pixel ratio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resize() {
  W = wrap.clientWidth;
  H = wrap.clientHeight;
  bgCanvas.width   = mainCanvas.width   = Math.round(W * DPR);
  bgCanvas.height  = mainCanvas.height  = Math.round(H * DPR);
  bgCanvas.style.width   = mainCanvas.style.width   = W + 'px';
  bgCanvas.style.height  = mainCanvas.style.height  = H + 'px';
  bgCtx.setTransform(DPR, 0, 0, DPR, 0, 0);
  ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
  drawGuides();
}
resize();
window.addEventListener('resize', () => { resize(); redrawHistory(); });

// â”€â”€ Guide lines â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawGuides() {
  bgCtx.clearRect(0, 0, W, H);
  bgCtx.strokeStyle = 'rgba(255,255,255,0.045)';
  bgCtx.lineWidth = 1;
  const cx = W/2, cy = H/2;
  for (let i = 0; i < symmetry; i++) {
    const a = (i / symmetry) * Math.PI * 2;
    bgCtx.beginPath();
    bgCtx.moveTo(cx, cy);
    bgCtx.lineTo(cx + Math.cos(a) * Math.max(W, H) * 1.5,
                 cy + Math.sin(a) * Math.max(W, H) * 1.5);
    bgCtx.stroke();
  }
  bgCtx.fillStyle = 'rgba(255,45,85,0.25)';
  bgCtx.beginPath();
  bgCtx.arc(cx, cy, 3, 0, Math.PI * 2);
  bgCtx.fill();
}

// â”€â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveSnapshot() {
  // Save at physical pixel size
  const snap = ctx.getImageData(0, 0, Math.round(W*DPR), Math.round(H*DPR));
  history.push(snap);
  if (history.length > 30) history.shift();
}

function redrawHistory() {
  // putImageData ignores the current transform, so we reset it temporarily
  ctx.save();
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  if (history.length > 0) {
    ctx.putImageData(history[history.length - 1], 0, 0);
  } else {
    ctx.clearRect(0, 0, Math.round(W*DPR), Math.round(H*DPR));
  }
  ctx.restore();
}

// â”€â”€ Colour helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getColor() {
  if (rainbow) {
    hue = (hue + 1.5) % 360;
    return `hsla(${hue},100%,60%,${alpha})`;
  }
  const r = parseInt(color.slice(1,3),16);
  const g = parseInt(color.slice(3,5),16);
  const b = parseInt(color.slice(5,7),16);
  return `rgba(${r},${g},${b},${alpha})`;
}

function applyGlow(c) {
  ctx.shadowBlur  = glowAmount > 0 ? glowAmount * 2 : 0;
  ctx.shadowColor = c;
}

// â”€â”€ Draw line with symmetry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawSegment(x1, y1, x2, y2) {
  const cx = W/2, cy = H/2;
  const c  = getColor();
  ctx.strokeStyle = c;
  ctx.lineWidth   = lineWidth;
  ctx.lineCap     = lineCap;
  ctx.lineJoin    = 'round';
  applyGlow(c);
  const dx1 = x1-cx, dy1 = y1-cy;
  const dx2 = x2-cx, dy2 = y2-cy;
  for (let i = 0; i < symmetry; i++) {
    const a = (i / symmetry) * Math.PI * 2;
    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(a);
    ctx.beginPath(); ctx.moveTo(dx1,dy1); ctx.lineTo(dx2,dy2); ctx.stroke();
    if (mirror) {
      ctx.scale(-1, 1);
      ctx.beginPath(); ctx.moveTo(dx1,dy1); ctx.lineTo(dx2,dy2); ctx.stroke();
    }
    ctx.restore();
  }
}

// â”€â”€ Stamp with symmetry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function placeStamp(x, y) {
  const cx = W/2, cy = H/2;
  const sz = stampSizePx;
  ctx.shadowBlur = 0;
  ctx.font = `${sz}px serif`;
  ctx.textAlign    = 'center';
  ctx.textBaseline = 'middle';
  const dx = x - cx, dy = y - cy;
  for (let i = 0; i < symmetry; i++) {
    const a = (i / symmetry) * Math.PI * 2;
    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(a);
    ctx.fillText(stampEmoji, dx, dy);
    if (mirror) {
      ctx.scale(-1, 1);
      ctx.fillText(stampEmoji, dx, dy);
    }
    ctx.restore();
  }
}

// â”€â”€ Pointer position helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPos(e) {
  const rect = mainCanvas.getBoundingClientRect();
  if (e.touches) return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
  return { x: e.clientX - rect.left, y: e.clientY - rect.top };
}

// â”€â”€ Canvas events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
mainCanvas.addEventListener('pointerdown', (e) => {
  if (spiroMode) return;
  const p = getPos(e);
  if (stampMode) {
    saveSnapshot();
    placeStamp(p.x, p.y);
    return;
  }
  isDrawing = true;
  saveSnapshot();
  lastX = p.x; lastY = p.y;
  mainCanvas.setPointerCapture(e.pointerId);
});

mainCanvas.addEventListener('pointermove', (e) => {
  if (!isDrawing || spiroMode || stampMode) return;
  const p = getPos(e);
  drawSegment(lastX, lastY, p.x, p.y);
  lastX = p.x; lastY = p.y;
});

mainCanvas.addEventListener('pointerup',     () => { isDrawing = false; });
mainCanvas.addEventListener('pointercancel', () => { isDrawing = false; });

// â”€â”€ Spirograph â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startSpiro() {
  if (spiroRAF) cancelAnimationFrame(spiroRAF);
  spiroAngle = 0; spiroLastX = null;
  spiroActive = true;
  saveSnapshot();
  animSpiro();
}
function stopSpiro() {
  spiroActive = false;
  if (spiroRAF) cancelAnimationFrame(spiroRAF);
  spiroRAF = null;
}
function animSpiro() {
  if (!spiroActive) return;
  const R = Math.min(W, H) * 0.38;
  const r = spiroR, d = spiroD;
  spiroAngle += spiroSpeed * 0.008;
  const x = W/2 + (R-r)*Math.cos(spiroAngle) + d*Math.cos(((R-r)/r)*spiroAngle);
  const y = H/2 + (R-r)*Math.sin(spiroAngle) - d*Math.sin(((R-r)/r)*spiroAngle);
  if (spiroLastX !== null) drawSegment(spiroLastX, spiroLastY, x, y);
  spiroLastX = x; spiroLastY = y;
  spiroRAF = requestAnimationFrame(animSpiro);
}

// â”€â”€ Save â€” full resolution, nothing cropped â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// The mainCanvas is already sized at W*DPR Ã— H*DPR physical pixels.
// We simply copy it to a fresh canvas (no CSS scaling tricks) so that the
// exported PNG contains every pixel that was painted, including those
// outside the visible viewport chrome.
document.getElementById('saveBtn').addEventListener('click', () => {
  const pw = Math.round(W * DPR);
  const ph = Math.round(H * DPR);

  const tmp = document.createElement('canvas');
  tmp.width  = pw;
  tmp.height = ph;
  const tc   = tmp.getContext('2d');

  // Dark background
  tc.fillStyle = '#050508';
  tc.fillRect(0, 0, pw, ph);

  // Draw the physical-pixel drawing canvas directly (1:1 copy, no scaling)
  tc.drawImage(mainCanvas, 0, 0);

  const link = document.createElement('a');
  link.download = `spirodraw_${Date.now()}.png`;
  link.href = tmp.toDataURL('image/png');
  link.click();

  const flash = document.getElementById('save-flash');
  flash.classList.add('show');
  setTimeout(() => flash.classList.remove('show'), 1400);
});

// â”€â”€ UI wiring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    stampMode = btn.dataset.tab === 'stempel';
    wrap.classList.toggle('stamp-mode', stampMode);
  });
});

document.querySelectorAll('.color-swatch').forEach(sw => {
  sw.addEventListener('click', () => {
    document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
    sw.classList.add('selected');
    color = sw.dataset.color;
  });
});

document.getElementById('customColor').addEventListener('input', e => {
  color = e.target.value;
  document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
});
document.getElementById('alphaSlider').addEventListener('input',  e => { alpha      = e.target.value / 100; });
document.getElementById('sizeSlider').addEventListener('input',   e => { lineWidth  = +e.target.value; });
document.getElementById('glowSlider').addEventListener('input',   e => { glowAmount = +e.target.value; });
document.getElementById('rainbowToggle').addEventListener('change', e => { rainbow = e.target.checked; });

document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    lineCap = btn.dataset.mode === 'round' ? 'round' : 'square';
  });
});

document.querySelectorAll('.sym-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.sym-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    symmetry = +btn.dataset.sym;
    drawGuides();
  });
});

document.getElementById('mirrorToggle').addEventListener('change', e => { mirror = e.target.checked; });

document.getElementById('spiroToggle').addEventListener('change', e => {
  spiroMode = e.target.checked;
  if (spiroMode) startSpiro(); else stopSpiro();
});

['spiroR','spiroD','spiroSpeed'].forEach(id => {
  document.getElementById(id).addEventListener('input', e => {
    if (id==='spiroR') spiroR = +e.target.value;
    if (id==='spiroD') spiroD = +e.target.value;
    if (id==='spiroSpeed') spiroSpeed = +e.target.value;
    if (spiroMode) startSpiro();
  });
});

document.getElementById('stampSize').addEventListener('input', e => { stampSizePx = +e.target.value; });

document.getElementById('undoBtn').addEventListener('click', () => {
  if (history.length > 1) {
    history.pop();
    redrawHistory();
  } else {
    history = [];
    ctx.save();
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0, 0, Math.round(W*DPR), Math.round(H*DPR));
    ctx.restore();
  }
});

document.getElementById('clearBtn').addEventListener('click', () => {
  saveSnapshot();
  ctx.save();
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0, 0, Math.round(W*DPR), Math.round(H*DPR));
  ctx.restore();
  history = [];
  if (spiroMode) startSpiro();
});
</script>
</body>
</html>
